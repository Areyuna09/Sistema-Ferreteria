<?xml version="1.0" encoding="UTF-8"?>

<?import javafx.scene.control.*?>
<?import javafx.scene.layout.*?>
<?import javafx.geometry.Insets?>

<BorderPane xmlns:fx="http://javafx.com/fxml"
            fx:controller="com.ferreteria.controllers.NewSaleController"
            style="-fx-background-color: #f1f5f9;"
            prefWidth="1200" prefHeight="700">

    <!-- Header -->
    <top>
        <HBox style="-fx-background-color: linear-gradient(to right, #0f172a, #1e3a5f); -fx-padding: 12 20;"
              alignment="CENTER_LEFT" spacing="16">

            <Button text="Volver" onAction="#handleVolver"
                    style="-fx-background-color: rgba(255,255,255,0.15); -fx-text-fill: white; -fx-font-weight: bold; -fx-padding: 8 16; -fx-background-radius: 6;"/>

            <VBox spacing="2">
                <Label text="Punto de Venta" style="-fx-font-size: 18px; -fx-font-weight: bold; -fx-text-fill: white;"/>
                <HBox spacing="8" alignment="CENTER_LEFT">
                    <Label fx:id="fechaLabel" text="Fecha" style="-fx-font-size: 11px; -fx-text-fill: rgba(255,255,255,0.7);"/>
                    <Button fx:id="btnCambiarFecha" text="Cambiar" onAction="#handleCambiarFecha"
                            style="-fx-background-color: rgba(255,255,255,0.2); -fx-text-fill: white; -fx-font-size: 9px; -fx-padding: 2 8; -fx-background-radius: 4;"/>
                </HBox>
            </VBox>

            <Region HBox.hgrow="ALWAYS"/>

            <VBox alignment="CENTER_RIGHT" spacing="2">
                <Label fx:id="vendedorLabel" text="Vendedor" style="-fx-font-size: 13px; -fx-font-weight: bold; -fx-text-fill: white;"/>
                <Label fx:id="turnoLabel" text="Turno" style="-fx-font-size: 10px; -fx-text-fill: #67e8f9;"/>
            </VBox>
        </HBox>
    </top>

    <!-- Contenido Principal -->
    <center>
        <HBox spacing="0">
            <!-- Panel Izquierdo: Búsqueda y productos (60%) -->
            <VBox style="-fx-background-color: #f8fafc;" spacing="12" HBox.hgrow="ALWAYS">
                <padding>
                    <Insets top="16" right="16" bottom="16" left="16"/>
                </padding>

                <!-- Buscador -->
                <VBox spacing="6">
                    <Label text="BUSCAR PRODUCTO" style="-fx-font-size: 11px; -fx-font-weight: bold; -fx-text-fill: #64748b;"/>
                    <HBox spacing="10">
                        <TextField fx:id="searchField" promptText="Codigo, nombre o SKU..."
                                   HBox.hgrow="ALWAYS"
                                   style="-fx-background-color: white; -fx-border-color: #e2e8f0; -fx-border-width: 1; -fx-border-radius: 8; -fx-background-radius: 8; -fx-padding: 10 14; -fx-font-size: 13px;"
                                   onAction="#handleBuscar"/>
                        <Button text="Buscar" onAction="#handleBuscar" styleClass="action-button"/>
                    </HBox>
                </VBox>

                <!-- Resultados de búsqueda -->
                <VBox VBox.vgrow="ALWAYS" spacing="6">
                    <Label text="RESULTADOS" style="-fx-font-size: 11px; -fx-font-weight: bold; -fx-text-fill: #64748b;"/>
                    <ListView fx:id="productosListView" VBox.vgrow="ALWAYS"
                              style="-fx-background-color: white; -fx-background-radius: 8; -fx-border-radius: 8; -fx-border-color: #e2e8f0;"/>
                </VBox>

                <!-- Producto seleccionado -->
                <VBox fx:id="productoSeleccionadoBox" spacing="10" visible="false" managed="false"
                      style="-fx-background-color: white; -fx-background-radius: 10; -fx-border-color: #0ea5e9; -fx-border-width: 2; -fx-border-radius: 10; -fx-padding: 12;">
                    <HBox alignment="CENTER_LEFT" spacing="12">
                        <VBox HBox.hgrow="ALWAYS" spacing="3">
                            <Label fx:id="productoNombreLabel" text="Producto" style="-fx-font-size: 14px; -fx-font-weight: bold; -fx-text-fill: #0f172a;"/>
                            <Label fx:id="productoPrecioLabel" text="Precio" style="-fx-font-size: 18px; -fx-font-weight: bold; -fx-text-fill: #0ea5e9;"/>
                            <Label fx:id="productoStockLabel" text="Stock: 0" style="-fx-font-size: 11px; -fx-text-fill: #64748b;"/>
                        </VBox>
                        <VBox spacing="3" alignment="CENTER">
                            <Label text="Cantidad" style="-fx-font-size: 10px; -fx-font-weight: bold; -fx-text-fill: #64748b;"/>
                            <HBox spacing="6" alignment="CENTER">
                                <Button text="-" onAction="#handleDecrementarCantidad"
                                        style="-fx-background-color: #f1f5f9; -fx-font-weight: bold; -fx-font-size: 14px; -fx-min-width: 32; -fx-min-height: 32; -fx-background-radius: 6;"/>
                                <TextField fx:id="cantidadField" text="1" prefWidth="50" alignment="CENTER"
                                           style="-fx-background-color: white; -fx-border-color: #e2e8f0; -fx-border-radius: 4; -fx-background-radius: 4; -fx-font-size: 13px; -fx-font-weight: bold;"/>
                                <Button text="+" onAction="#handleIncrementarCantidad"
                                        style="-fx-background-color: #f1f5f9; -fx-font-weight: bold; -fx-font-size: 14px; -fx-min-width: 32; -fx-min-height: 32; -fx-background-radius: 6;"/>
                            </HBox>
                        </VBox>
                        <Button text="Agregar" onAction="#handleAgregarAlCarrito" prefHeight="44"
                                style="-fx-background-color: #22c55e; -fx-text-fill: white; -fx-font-weight: bold; -fx-padding: 10 20; -fx-background-radius: 8;"/>
                    </HBox>
                </VBox>
            </VBox>

            <!-- Panel Derecho: Carrito (40%, min 360) -->
            <VBox minWidth="360" maxWidth="400" spacing="0" style="-fx-background-color: white; -fx-border-color: #e2e8f0; -fx-border-width: 0 0 0 1;">

                <!-- Header del carrito -->
                <HBox alignment="CENTER_LEFT" spacing="10" style="-fx-background-color: #f8fafc; -fx-border-color: #e2e8f0; -fx-border-width: 0 0 1 0; -fx-padding: 12;">
                    <Label text="Carrito" style="-fx-font-size: 15px; -fx-font-weight: bold; -fx-text-fill: #0f172a;"/>
                    <Region HBox.hgrow="ALWAYS"/>
                    <Button text="Vaciar" onAction="#handleVaciarCarrito"
                            style="-fx-background-color: transparent; -fx-text-fill: #dc2626; -fx-font-size: 11px;"/>
                </HBox>

                <!-- Items del carrito -->
                <ScrollPane VBox.vgrow="ALWAYS" fitToWidth="true" style="-fx-background-color: transparent; -fx-background: transparent;">
                    <VBox fx:id="carritoContainer" spacing="6" style="-fx-padding: 10;">
                    </VBox>
                </ScrollPane>

                <!-- Totales -->
                <VBox spacing="6" style="-fx-background-color: #f8fafc; -fx-border-color: #e2e8f0; -fx-border-width: 1 0 0 0; -fx-padding: 12;">
                    <HBox alignment="CENTER_LEFT">
                        <Label text="Subtotal:" style="-fx-font-size: 12px; -fx-text-fill: #64748b;"/>
                        <Region HBox.hgrow="ALWAYS"/>
                        <Label fx:id="subtotalLabel" text="0.00" style="-fx-font-size: 12px; -fx-font-weight: bold;"/>
                    </HBox>
                    <HBox alignment="CENTER_LEFT">
                        <Label text="Items:" style="-fx-font-size: 12px; -fx-text-fill: #64748b;"/>
                        <Region HBox.hgrow="ALWAYS"/>
                        <Label fx:id="itemsCountLabel" text="0" style="-fx-font-size: 12px; -fx-font-weight: bold;"/>
                    </HBox>
                    <Separator/>
                    <HBox alignment="CENTER_LEFT">
                        <Label text="TOTAL:" style="-fx-font-size: 16px; -fx-font-weight: bold;"/>
                        <Region HBox.hgrow="ALWAYS"/>
                        <Label fx:id="totalLabel" text="0.00" style="-fx-font-size: 20px; -fx-font-weight: bold; -fx-text-fill: #0ea5e9;"/>
                    </HBox>
                </VBox>

                <!-- Método de pago -->
                <VBox spacing="8" style="-fx-background-color: white; -fx-border-color: #e2e8f0; -fx-border-width: 1 0 0 0; -fx-padding: 10 12;">
                    <Label text="METODO DE PAGO" style="-fx-font-size: 10px; -fx-font-weight: bold; -fx-text-fill: #64748b;"/>

                    <!-- Checkboxes de métodos -->
                    <HBox spacing="12" alignment="CENTER_LEFT">
                        <CheckBox fx:id="chkEfectivo" text="Efectivo" selected="true"/>
                        <CheckBox fx:id="chkTarjeta" text="Tarjeta"/>
                        <CheckBox fx:id="chkTransferencia" text="Transfer"/>
                    </HBox>

                    <!-- Montos (solo visibles si hay múltiples métodos) -->
                    <HBox spacing="8" alignment="CENTER_LEFT">
                        <TextField fx:id="montoEfectivo" promptText="Efectivo $" prefWidth="85" style="-fx-font-size: 11px;" visible="false" managed="false"/>
                        <TextField fx:id="montoTarjeta" promptText="Tarjeta $" prefWidth="85" style="-fx-font-size: 11px;" visible="false" managed="false"/>
                        <TextField fx:id="montoTransferencia" promptText="Transfer $" prefWidth="85" style="-fx-font-size: 11px;" visible="false" managed="false"/>
                        <Label fx:id="pagoValidacionLabel" text="" style="-fx-font-size: 10px;"/>
                    </HBox>

                    <!-- Cálculo de vuelto (solo efectivo) -->
                    <HBox fx:id="efectivoVueltoBox" spacing="8" alignment="CENTER_LEFT">
                        <Label text="Recibido:" style="-fx-font-size: 10px; -fx-text-fill: #64748b;"/>
                        <TextField fx:id="recibidoField" promptText="0.00" prefWidth="70" onKeyReleased="#handleRecibidoChanged" style="-fx-font-size: 11px;"/>
                        <Label text="Vuelto:" style="-fx-font-size: 10px; -fx-text-fill: #64748b;"/>
                        <Label fx:id="cambioLabel" text="0.00" style="-fx-font-size: 11px; -fx-font-weight: bold; -fx-text-fill: #22c55e;"/>
                    </HBox>
                </VBox>

                <!-- Notas -->
                <VBox spacing="6" style="-fx-padding: 6 12;">
                    <TextField fx:id="notasField" promptText="Notas (opcional)..."
                               style="-fx-background-color: #f8fafc; -fx-border-color: #e2e8f0; -fx-border-radius: 6; -fx-background-radius: 6; -fx-padding: 8 10; -fx-font-size: 11px;"/>
                </VBox>

                <!-- Botón de confirmar -->
                <VBox style="-fx-background-color: white; -fx-border-color: #e2e8f0; -fx-border-width: 1 0 0 0; -fx-padding: 10 12 12 12;">
                    <Button fx:id="confirmarBtn" text="CONFIRMAR VENTA" onAction="#handleConfirmarVenta"
                            maxWidth="Infinity" prefHeight="48" disable="true"
                            style="-fx-background-color: linear-gradient(to right, #22c55e, #16a34a); -fx-text-fill: white; -fx-font-size: 14px; -fx-font-weight: bold; -fx-background-radius: 10;"/>
                </VBox>
            </VBox>
        </HBox>
    </center>

</BorderPane>
